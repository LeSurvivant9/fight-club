---
services:
  jellyfin:
    extends:
      file: ../common.yml
      service: common-config
    image: lscr.io/linuxserver/jellyfin:arm64v8-latest
    container_name: jellyfin
    networks:
      - proxy
    volumes:
      - /opt/jellyfin/config:/config
      - /opt/jellyfin/cache:/cache
      - ${MEDIA}:/media
    devices:
      - /dev/video19:/dev/video19
      - /dev/dma_heap:/dev/dma_heap
    healthcheck:
      test: [CMD, curl, -f, 'http://localhost:8096/']
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      # Router API (SANS Authentik) - Pour applications mobiles
      - traefik.http.routers.jellyfin-api.entrypoints=https
      - traefik.http.routers.jellyfin-api.rule=Host(`jellyfin.${DOMAIN}`) && PathPrefix(`/System`,`/Users`,`/Items`,`/Shows`,`/Movies`,`/MusicAlbums`,`/MusicArtists`,`/Playlists`,`/Sessions`,`/Notifications`,`/ScheduledTasks`,`/Plugins`,`/Branding`,`/DisplayPreferences`,`/Library`,`/hubs`,`/LiveTV`,`/Videos`,`/Audio`,`/Auth`)
      - traefik.http.routers.jellyfin-api.tls=true
      - traefik.http.routers.jellyfin-api.tls.certresolver=cloudflare
      - traefik.http.routers.jellyfin-api.service=jellyfin
      - traefik.http.routers.jellyfin-api.middlewares=no-index@file
      - traefik.http.routers.jellyfin-api.priority=100
      # Router WEB (AVEC Authentik) - Pour interface web
      - traefik.http.routers.jellyfin-web.entrypoints=https
      - traefik.http.routers.jellyfin-web.rule=Host(`jellyfin.${DOMAIN}`)
      - traefik.http.routers.jellyfin-web.tls=true
      - traefik.http.routers.jellyfin-web.tls.certresolver=cloudflare
      - traefik.http.routers.jellyfin-web.service=jellyfin
      - traefik.http.routers.jellyfin-web.middlewares=authentik-forwardauth@file,no-index@file
      # Service
      - traefik.http.services.jellyfin.loadbalancer.server.port=8096
networks:
  proxy:
    external: true
    name: proxy
