---
services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    user: ${PUID}:${PGID}
    environment:
      - TZ=${TZ}
      - FIREWALL_VPN_INPUT_PORTS=${FIREWALL_VPN_INPUT_PORTS}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES}
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}
      - VPN_TYPE=${VPN_TYPE}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - WIREGUARD_PRESHARED_KEY=${WIREGUARD_PRESHARED_KEY}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      proxy:
    configs:
      - source: post-rules.txt
        target: /iptables/post-rules.txt
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ports:
      - "8888:8888/tcp" # HTTP proxy
      - "8388:8388/tcp" # Shadowsocks
      - "8388:8388/udp" # Shadowsocks
      - "5274:5274/tcp" # Nicotine+
      - "8191:8191" # Flaresolverr
      - "65144:65144/tcp"
      - "65144:65144/udp"
    volumes:
      - /opt/gluetun/appdata:/gluetun
      - /lib/modules:/lib/modules:ro
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=1
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.qbittorrent-secure.entrypoints=https"
      - "traefik.http.routers.qbittorrent-secure.rule=Host(`qbittorrent.${DOMAIN}`)"
      - "traefik.http.routers.qbittorrent-secure.tls=true"
      - "traefik.http.routers.qbittorrent-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.qbittorrent-secure.service=qbittorrent"
      - "traefik.http.routers.qbittorrent-secure.middlewares=compress@file"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8081"
      - "traefik.http.routers.nicotine-secure.entrypoints=https"
      - "traefik.http.routers.nicotine-secure.rule=Host(`nicotine.${DOMAIN}`)"
      - "traefik.http.routers.nicotine-secure.tls=true"
      - "traefik.http.routers.nicotine-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.nicotine-secure.service=nicotine"
      - "traefik.http.routers.nicotine-secure.middlewares=compress@file"
      - "traefik.http.services.nicotine.loadbalancer.server.port=6565"
      - "traefik.http.routers.znc-secure.entrypoints=https"
      - "traefik.http.routers.znc-secure.rule=Host(`znc.${DOMAIN}`)"
      - "traefik.http.routers.znc-secure.tls=true"
      - "traefik.http.routers.znc-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.znc-secure.service=znc"
      - "traefik.http.routers.znc-secure.middlewares=compress@file"
      - "traefik.http.services.znc.loadbalancer.server.port=8080"
      - "traefik.tcp.routers.znc-irc-tcp.entrypoints=websecure_tcp"
      - "traefik.tcp.routers.znc-irc-tcp.rule=HostSNI(`znc-irc.${DOMAIN}`)"
      - "traefik.tcp.routers.znc-irc-tcp.tls=true"
      - "traefik.tcp.routers.znc-irc-tcp.tls.certresolver=cloudflare"
      - "traefik.tcp.routers.znc-irc-tcp.tls.domains[0].main=${DOMAIN}"
      - "traefik.tcp.routers.znc-irc-tcp.tls.domains[0].sans=*.${DOMAIN}"
      - "traefik.tcp.routers.znc-irc-tcp.service=znc-irc-tcp"
      - "traefik.tcp.services.znc-irc-tcp.loadbalancer.server.port=6697"
      - "traefik.http.routers.prowlarr-secure.entrypoints=https"
      - "traefik.http.routers.prowlarr-secure.rule=Host(`prowlarr.${DOMAIN}`)"
      - "traefik.http.routers.prowlarr-secure.tls=true"
      - "traefik.http.routers.prowlarr-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.prowlarr-secure.service=prowlarr"
      - "traefik.http.routers.prowlarr-secure.middlewares=compress@file"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
      - "traefik.http.routers.autobrr-secure.entrypoints=https"
      - "traefik.http.routers.autobrr-secure.rule=Host(`autobrr.${DOMAIN}`)"
      - "traefik.http.routers.autobrr-secure.tls=true"
      - "traefik.http.routers.autobrr-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.autobrr-secure.service=autobrr"
      - "traefik.http.routers.autobrr-secure.middlewares=compress@file"
      - "traefik.http.services.autobrr.loadbalancer.server.port=7474"
      #      - "traefik.http.routers.wg-secure.tls=true"
      #      - "traefik.http.routers.wg-secure.entrypoints=https"
      #      - "traefik.http.routers.wg-secure.rule=Host(`wg.${DOMAIN}`)"
      #      - "traefik.http.routers.wg-secure.tls.certresolver=cloudflare"
      #      - "traefik.http.routers.wg-secure.service=wg"
      #      - "traefik.http.routers.wg-secure.middlewares=compress@file"
      #      - "traefik.http.services.wg.loadbalancer.server.port=51821"
      - "traefik.http.routers.deemix-secure.entrypoints=https"
      - "traefik.http.routers.deemix-secure.rule=Host(`deemix.${DOMAIN}`)"
      - "traefik.http.routers.deemix-secure.tls=true"
      - "traefik.http.routers.deemix-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.deemix-secure.service=deemix"
      - "traefik.http.routers.deemix-secure.middlewares=compress@file"
      - "traefik.http.services.deemix.loadbalancer.server.port=6595"
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    user: ${PUID}:${PGID}
    environment:
      - TZ=${TZ}
      - TORRENTING_PORT=${TORRENTING_PORT}
      - WEBUI_PORT=${WEBUI_PORT}
    mem_limit: 2048M
    memswap_limit: 4096M
    network_mode: service:gluetun
    depends_on:
      - gluetun
    volumes:
      - /opt/qbittorrent/config:/config
      - ${MEDIA}:/media
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/ >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      diun.enable: true
  nicotineplus-proper:
    image: sirjmann92/nicotineplus-proper:latest
    user: ${PUID}:${PGID}
    container_name: nicotine
    shm_size: "1gb"
    environment:
      - TZ=${TZ}
      - LOGIN=${LOGIN}
      - PASSW=${PASSW}
      - WEB_UI_PORT=${WEB_UI_PORT}
    network_mode: service:gluetun
    depends_on:
      - gluetun
    volumes:
      - ${MEDIA}/downloads/deemix:/downloads
      - ${MEDIA}/musics:/musics
      - /opt/nicotine/shared:/shared
      - /opt/nicotine/config:/config
      - /opt/nicotine/config/data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:6565/ >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      diun.enable: true
  znc:
    image: lscr.io/linuxserver/znc:latest
    container_name: znc
    user: ${PUID}:${PGID}
    environment:
      - TZ=${TZ}
      - IRC_INVITE_TOKEN=${IRC_INVITE_TOKEN}
      - IRC_NICK=${IRC_NICK}
      - RELAY_PASSWORD=${RELAY_PASSWORD}
    network_mode: service:gluetun
    depends_on:
      - gluetun
    volumes:
      - /opt/znc:/config
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/ >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      diun.enable: true
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    user: ${PUID}:${PGID}
    environment:
      - TZ=${TZ}
    mem_limit: 512M
    network_mode: service:gluetun
    depends_on:
      - gluetun
    volumes:
      - /opt/prowlarr/config:/config
      - ${MEDIA}:/media
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9696/ >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    user: ${PUID}:${PGID}
    environment:
      - TZ=${TZ}
      - CAPTCHA_SOLVER=${CAPTCHA_SOLVER}
      - LOG_HTML=${LOG_HTML}
      - LOG_LEVEL=${LOG_LEVEL}
    network_mode: service:gluetun
    depends_on:
      - gluetun
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8191/ >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
  autobrr:
    image: ghcr.io/autobrr/autobrr:latest
    container_name: autobrr
    user: ${PUID}:${PGID}
    environment:
      - TZ=${TZ}
    network_mode: service:gluetun
    depends_on:
      - gluetun
    volumes:
      - /opt/autobrr/config:/config
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:7474/ >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    #  wg-easy:
    #    image: ghcr.io/wg-easy/wg-easy:latest
    #    container_name: wg-easy
    #    env_file:
    #      - .env
    #    network_mode: service:gluetun
    #    depends_on:
    #      - gluetun
    #    volumes:
    #      - /opt/wg-easy/etc_wireguard:/etc/wireguard
    #      - /lib/modules:/lib/modules:ro
    #    restart: unless-stopped
    #    cap_add:
    #      - NET_ADMIN
    #      - SYS_MODULE
    #    healthcheck:
    #      test: ["CMD-SHELL", "timeout 5s wg show | grep -q interface >/dev/null"]
    #      interval: 30s
    #      timeout: 10s
    #      retries: 3
    #      start_period: 10s
    #    sysctls:
    #      - net.ipv4.ip_forward=1
    #      - net.ipv4.conf.all.src_valid_mark=1
    #      - net.ipv4.conf.all.rp_filter=0
    #      - net.ipv4.conf.default.rp_filter=0
    #    labels:
    #      diun.enable: true
  deemix:
    image: ghcr.io/bambanah/deemix:latest
    container_name: deemix
    user: ${PUID}:${PGID}
    environment:
      - TZ=${TZ}
      - DEEMIX_SINGLE_USER=${DEEMIX_SINGLE_USER}
    network_mode: service:gluetun
    depends_on:
      - gluetun
    volumes:
      - /opt/deemix/config:/config
      - ${MEDIA}/downloads/deemix:/downloads
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6595/ >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
networks:
  proxy:
    external: true
configs:
  post-rules.txt:
    content: |-
      iptables -A FORWARD -i eth+ -o tun0 -j ACCEPT
      iptables -A FORWARD -i tun0 -o eth+ -m state --state RELATED,ESTABLISHED -j ACCEPT
      iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE
